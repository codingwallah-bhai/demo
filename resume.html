<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Modern Resume Builder</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <style>
        /* Mobile & Print Optimizations */
        @media print {
            @page { margin: 0; size: auto; }
            body { margin: 0; padding: 0; background: white; }
            nav, .print\:hidden, #editor-section, #tab-buttons, #toast-container { display: none !important; }
            #preview-section { 
                display: block !important; 
                width: 100% !important; 
                position: absolute !important; 
                top: 0 !important; 
                left: 0 !important; 
            }
            .max-w-7xl { max-width: none !important; padding: 0 !important; margin: 0 !important; }
            #resume-preview-container { 
                padding: 0 !important; 
                width: 100% !important; 
                height: 100% !important; 
                box-shadow: none !important; 
                margin: 0 !important;
            }
            * { -webkit-print-color-adjust: exact !important; print-color-adjust: exact !important; }
        }
        
        .a4-ratio { aspect-ratio: 1 / 1.4142; }

        /* Smooth scroll & Mobile height fix */
        .custom-scroll {
            -webkit-overflow-scrolling: touch;
        }
        .custom-scroll::-webkit-scrollbar { width: 6px; }
        .custom-scroll::-webkit-scrollbar-track { background: #f1f1f1; }
        .custom-scroll::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        
        /* Hide scrollbar for layout selector but keep functionality */
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
    </style>
</head>
<body class="bg-gray-100 font-sans text-gray-800 h-screen overflow-hidden flex flex-col">

    <!-- Navbar -->
    <nav class="bg-white shadow-sm z-50 flex-none print:hidden">
        <div class="max-w-7xl mx-auto px-2 sm:px-6 lg:px-8">
            <div class="flex justify-between h-14 items-center">
                
                <!-- Logo & Status -->
                <div class="flex items-center gap-2 min-w-fit">
                    <i data-lucide="layout" class="h-6 w-6 text-blue-600"></i>
                    <span class="font-bold text-lg text-gray-900 hidden sm:block">ResumeBuilder</span>
                    
                    <!-- Auto Save Status Indicator -->
                    <div class="flex items-center gap-1 ml-2 px-2 py-1 bg-gray-50 rounded text-xs font-medium text-gray-500 border border-gray-200" id="cloud-status">
                        <i data-lucide="cloud" class="h-3 w-3"></i>
                        <span id="save-text">Ready</span>
                    </div>
                </div>
                
                <!-- Controls (Scrollable on mobile) -->
                <div class="flex items-center gap-2 overflow-x-auto no-scrollbar ml-2 pl-2">
                    
                    <!-- Layout Selector -->
                    <select onchange="window.handleLayoutChange(this.value)" id="layout-select" class="bg-gray-50 border border-gray-300 text-gray-900 text-xs rounded-lg focus:ring-blue-500 focus:border-blue-500 block p-1.5 min-w-[90px]">
                        <option value="modern">Modern</option>
                        <option value="classic">Classic</option>
                        <option value="minimalist">Minimal</option>
                        <option value="professional">Pro</option>
                    </select>

                    <!-- Color Pickers -->
                    <div class="flex gap-1 flex-shrink-0" id="color-picker-container">
                        <!-- Colors injected by JS -->
                    </div>

                    <!-- Download Button -->
                    <button onclick="window.print()" class="flex-shrink-0 inline-flex items-center px-3 py-1.5 border border-transparent text-xs font-medium rounded-md shadow-sm text-white bg-blue-600 hover:bg-blue-700 focus:outline-none">
                        <i data-lucide="download" class="h-4 w-4"></i>
                        <span class="hidden sm:inline ml-1">PDF</span>
                    </button>
                </div>
            </div>
        </div>
    </nav>

    <!-- Mobile Tabs -->
    <div id="tab-buttons" class="md:hidden bg-white border-b border-gray-200 flex-none z-40 print:hidden">
        <div class="flex">
            <button onclick="window.switchTab('editor')" id="tab-editor" class="flex-1 py-3 text-sm font-medium text-center border-b-2 border-blue-600 text-blue-600">Editor</button>
            <button onclick="window.switchTab('preview')" id="tab-preview" class="flex-1 py-3 text-sm font-medium text-center border-b-2 border-transparent text-gray-500">Preview</button>
        </div>
    </div>

    <!-- Main Content Area -->
    <main class="flex-1 overflow-hidden relative max-w-7xl mx-auto w-full">
        <div class="h-full flex flex-col md:flex-row gap-0 md:gap-8 px-0 md:px-4 py-0 md:py-6">
            
            <!-- EDITOR SECTION -->
            <div id="editor-section" class="w-full md:w-5/12 lg:w-4/12 h-full overflow-y-auto custom-scroll p-4 pb-24 md:pb-4 space-y-6 bg-gray-50 md:bg-transparent print:hidden">
                
                <!-- Personal Info -->
                <div class="bg-white shadow-sm md:shadow rounded-lg p-4 md:p-6">
                    <h2 class="text-lg font-medium text-gray-900 mb-4 flex items-center gap-2">
                        <i data-lucide="user" class="h-5 w-5 text-gray-500"></i> Personal
                    </h2>
                    
                    <!-- Image Upload -->
                    <div class="mb-4">
                        <label class="block text-xs font-medium text-gray-700 mb-1">Profile Photo</label>
                        <div class="flex items-center gap-3">
                            <div id="image-preview-mini" class="h-10 w-10 rounded-full bg-gray-200 flex items-center justify-center overflow-hidden border border-gray-300 flex-shrink-0">
                                <i data-lucide="image" class="h-5 w-5 text-gray-400"></i>
                            </div>
                            <input type="file" accept="image/*" onchange="window.handleImageUpload(this)" class="block w-full text-xs text-gray-500 file:mr-2 file:py-1.5 file:px-3 file:rounded-md file:border-0 file:text-xs file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100"/>
                        </div>
                    </div>

                    <div class="grid grid-cols-1 gap-3" id="personal-form">
                        <!-- Inputs injected -->
                    </div>
                </div>

                <!-- Experience -->
                <div class="bg-white shadow-sm md:shadow rounded-lg p-4 md:p-6">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-lg font-medium text-gray-900 flex items-center gap-2">
                            <i data-lucide="briefcase" class="h-5 w-5 text-gray-500"></i> Experience
                        </h2>
                        <button onclick="window.addExperience()" class="inline-flex items-center p-1.5 rounded-full bg-blue-100 text-blue-700 hover:bg-blue-200">
                            <i data-lucide="plus" class="h-4 w-4"></i>
                        </button>
                    </div>
                    <div id="experience-list" class="space-y-4"></div>
                </div>

                <!-- Education -->
                <div class="bg-white shadow-sm md:shadow rounded-lg p-4 md:p-6">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-lg font-medium text-gray-900 flex items-center gap-2">
                            <i data-lucide="graduation-cap" class="h-5 w-5 text-gray-500"></i> Education
                        </h2>
                        <button onclick="window.addEducation()" class="inline-flex items-center p-1.5 rounded-full bg-blue-100 text-blue-700 hover:bg-blue-200">
                            <i data-lucide="plus" class="h-4 w-4"></i>
                        </button>
                    </div>
                    <div id="education-list" class="space-y-4"></div>
                </div>

                <!-- Skills -->
                <div class="bg-white shadow-sm md:shadow rounded-lg p-4 md:p-6">
                    <h2 class="text-lg font-medium text-gray-900 mb-2 flex items-center gap-2">
                        <i data-lucide="palette" class="h-5 w-5 text-gray-500"></i> Skills
                    </h2>
                    <textarea id="skills-input" rows="3" placeholder="Comma separated skills..." class="block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 text-sm p-2 border" oninput="window.handleSkillsChange(this.value)"></textarea>
                </div>
                
                <!-- Spacer for mobile scrolling -->
                <div class="h-10 md:hidden"></div>
            </div>

            <!-- PREVIEW SECTION -->
            <div id="preview-section" class="hidden md:block w-full md:w-7/12 lg:w-8/12 h-full overflow-y-auto custom-scroll bg-gray-200/50 p-4 md:p-0">
                <div class="sticky top-0 min-h-full flex flex-col items-center justify-start pt-4 pb-12">
                    <div id="resume-preview-container" class="shadow-lg print:shadow-none bg-white w-full max-w-[210mm] a4-ratio relative transition-all duration-300 origin-top transform md:scale-[0.85] lg:scale-100">
                        <!-- Resume Content -->
                    </div>
                    <p class="mt-4 text-xs text-gray-500 print:hidden">Auto-saving enabled. Changes sync instantly.</p>
                </div>
            </div>

        </div>
    </main>

    <!-- Toast Notification -->
    <div id="toast-container" class="fixed bottom-5 left-1/2 transform -translate-x-1/2 z-50 transition-all duration-300 translate-y-20 opacity-0 pointer-events-none">
        <div class="bg-gray-800/90 backdrop-blur text-white px-4 py-2 rounded-full shadow-lg flex items-center gap-2 text-sm">
            <i data-lucide="check" class="text-green-400 h-4 w-4"></i>
            <span id="toast-message">Saved</span>
        </div>
    </div>

    <!-- Firebase Logic -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-app.js";
        import { getDatabase, ref, set, get, child } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-database.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-auth.js";

        // Config
        const firebaseConfig = {
            apiKey: "AIzaSyCqo5MOtYA5nuhJ2awI0O7_Vm-Yp1rWVZw",
            authDomain: "cricket-2b0a1.firebaseapp.com",
            databaseURL: "https://cricket-2b0a1-default-rtdb.firebaseio.com",
            projectId: "cricket-2b0a1",
            storageBucket: "cricket-2b0a1.appspot.com",
            messagingSenderId: "481266922688",
            appId: "1:481266922688:web:3ab1a2668a72132c62e925",
            measurementId: "G-3DHH8ZCNXV"
        };

        // Init
        const app = initializeApp(firebaseConfig);
        const database = getDatabase(app);
        const auth = getAuth(app);

        let currentUser = null;
        let saveTimeout = null;
        let isSaving = false;

        // Auth Listener
        onAuthStateChanged(auth, (user) => {
            if (user) {
                currentUser = user;
                // Check URL for ID to load data
                const urlParams = new URLSearchParams(window.location.search);
                const id = urlParams.get('id');
                
                if (id) {
                    appState.resumeId = id;
                    loadFromFirebase(id);
                } else {
                    // Generate new ID if none
                    if (!appState.resumeId) {
                        appState.resumeId = 'res_' + Date.now() + '_' + Math.random().toString(36).substr(2, 5);
                        // Update URL
                        const newUrl = window.location.protocol + "//" + window.location.host + window.location.pathname + '?id=' + appState.resumeId;
                        window.history.replaceState({path:newUrl},'',newUrl);
                    }
                }
            } else {
                signInAnonymously(auth).catch(console.error);
            }
        });

        // --- AUTO SAVE FUNCTION ---
        window.triggerAutoSave = function() {
            if (!currentUser || !appState.resumeId) return;

            // UI Feedback: Saving...
            const saveText = document.getElementById('save-text');
            const cloudStatus = document.getElementById('cloud-status');
            if(saveText) saveText.innerText = "Saving...";
            if(cloudStatus) cloudStatus.classList.add('animate-pulse');

            // Debounce
            clearTimeout(saveTimeout);
            saveTimeout = setTimeout(() => {
                const resumeRef = ref(database, 'resumes/' + appState.resumeId);
                set(resumeRef, appState.data)
                    .then(() => {
                        if(saveText) saveText.innerText = "Saved";
                        if(cloudStatus) cloudStatus.classList.remove('animate-pulse');
                    })
                    .catch((err) => {
                        console.error("Save failed", err);
                        if(saveText) saveText.innerText = "Error";
                    });
            }, 1000); // 1 second delay after last keystroke
        };

        function loadFromFirebase(id) {
            const saveText = document.getElementById('save-text');
            if(saveText) saveText.innerText = "Loading...";
            
            get(child(ref(database), `resumes/${id}`)).then((snapshot) => {
                if (snapshot.exists()) {
                    appState.data = snapshot.val();
                    window.reInit(); // Refresh UI
                    if(saveText) saveText.innerText = "Loaded";
                } else {
                    if(saveText) saveText.innerText = "New";
                }
            }).catch((err) => {
                console.error(err);
                if(saveText) saveText.innerText = "Offline";
            });
        }
    </script>

    <script>
        // --- CORE APP LOGIC ---
        let appState = {
            layout: 'modern',
            theme: 'blue',
            resumeId: null,
            data: {
                personal: {
                    fullName: 'Vikram Sharma',
                    title: 'Software Engineer',
                    email: 'vikram@example.com',
                    phone: '+91 98765 43210',
                    address: 'Mumbai, India',
                    linkedin: '',
                    github: '',
                    photoUrl: null,
                    summary: 'Experienced developer building web applications.'
                },
                experience: [
                    { id: 1, company: 'Tech Corp', role: 'Developer', startDate: '2022', endDate: 'Present', description: 'Developing scalable frontend applications using React and Tailwind.' }
                ],
                education: [
                    { id: 1, school: 'Mumbai University', degree: 'B.Tech CS', startDate: '2018', endDate: '2022', location: 'Mumbai' }
                ],
                skills: 'JavaScript, React, Node.js, HTML, CSS'
            }
        };

        // Constants
        const colors = {
            blue: 'text-blue-700 border-blue-700',
            emerald: 'text-emerald-700 border-emerald-700',
            purple: 'text-purple-700 border-purple-700',
            slate: 'text-slate-800 border-slate-800',
            rose: 'text-rose-700 border-rose-700',
        };
        const bgColors = {
            blue: 'bg-blue-50', emerald: 'bg-emerald-50', purple: 'bg-purple-50', slate: 'bg-slate-50', rose: 'bg-rose-50',
        };
        const headerBgColors = {
             blue: 'bg-blue-700', emerald: 'bg-emerald-700', purple: 'bg-purple-700', slate: 'bg-slate-800', rose: 'bg-rose-700',
        }
        const iconColors = {
            blue: 'text-blue-600', emerald: 'text-emerald-600', purple: 'text-purple-600', slate: 'text-slate-600', rose: 'text-rose-600',
        };
        const themeMap = {
            blue: 'bg-blue-600', emerald: 'bg-emerald-600', purple: 'bg-purple-600', rose: 'bg-rose-600', slate: 'bg-slate-800'
        };

        function init() {
            renderColorPickers();
            renderPersonalInputs();
            renderExperienceList();
            renderEducationList();
            
            const skillsEl = document.getElementById('skills-input');
            if(skillsEl) skillsEl.value = appState.data.skills || "";
            
            document.getElementById('layout-select').value = appState.layout;
            
            renderPreview();
            if(window.lucide) lucide.createIcons();
        }

        // --- UI RENDERERS ---
        function renderColorPickers() {
            document.getElementById('color-picker-container').innerHTML = ['blue', 'emerald', 'purple', 'rose', 'slate'].map(c => `
                <button onclick="window.handleThemeChange('${c}')" 
                    class="w-5 h-5 rounded-full border border-gray-200 ${themeMap[c]} ${appState.theme === c ? 'ring-2 ring-offset-1 ring-gray-400' : ''}">
                </button>
            `).join('');
        }

        function renderPersonalInputs() {
            const fields = [
                { name: 'fullName', placeholder: 'Name' },
                { name: 'title', placeholder: 'Job Title' },
                { name: 'email', placeholder: 'Email', type: 'email' },
                { name: 'phone', placeholder: 'Phone' },
                { name: 'address', placeholder: 'City, Country' },
                { name: 'linkedin', placeholder: 'LinkedIn URL' },
                { name: 'github', placeholder: 'GitHub URL' },
            ];

            const html = fields.map(f => `
                <input type="${f.type || 'text'}" 
                    placeholder="${f.placeholder}" 
                    value="${appState.data.personal[f.name] || ''}" 
                    oninput="window.updatePersonal('${f.name}', this.value)"
                    class="block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 text-sm p-2 border">
            `).join('');
            
            const summaryHtml = `<textarea rows="3" placeholder="Professional Summary" oninput="window.updatePersonal('summary', this.value)" class="block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 text-sm p-2 border">${appState.data.personal.summary || ''}</textarea>`;
            
            document.getElementById('personal-form').innerHTML = html + summaryHtml;
        }

        function renderExperienceList() {
            document.getElementById('experience-list').innerHTML = appState.data.experience.map(exp => `
                <div class="relative bg-gray-50 p-3 rounded border border-gray-200 group">
                    <button onclick="window.removeExperience(${exp.id})" class="absolute top-2 right-2 text-gray-400 hover:text-red-500 p-1">
                        <i data-lucide="trash-2" class="h-4 w-4"></i>
                    </button>
                    <div class="space-y-2">
                        <input type="text" placeholder="Company" value="${exp.company}" oninput="window.updateExperience(${exp.id}, 'company', this.value)" class="block w-full rounded border-gray-300 text-sm p-1.5 border">
                        <input type="text" placeholder="Role" value="${exp.role}" oninput="window.updateExperience(${exp.id}, 'role', this.value)" class="block w-full rounded border-gray-300 text-sm p-1.5 border">
                        <div class="grid grid-cols-2 gap-2">
                            <input type="text" placeholder="Start" value="${exp.startDate}" oninput="window.updateExperience(${exp.id}, 'startDate', this.value)" class="block w-full rounded border-gray-300 text-sm p-1.5 border">
                            <input type="text" placeholder="End" value="${exp.endDate}" oninput="window.updateExperience(${exp.id}, 'endDate', this.value)" class="block w-full rounded border-gray-300 text-sm p-1.5 border">
                        </div>
                        <textarea rows="2" placeholder="Details..." oninput="window.updateExperience(${exp.id}, 'description', this.value)" class="block w-full rounded border-gray-300 text-sm p-1.5 border">${exp.description}</textarea>
                    </div>
                </div>
            `).join('');
            if(window.lucide) lucide.createIcons();
        }

        function renderEducationList() {
            document.getElementById('education-list').innerHTML = appState.data.education.map(edu => `
                <div class="relative bg-gray-50 p-3 rounded border border-gray-200 group">
                    <button onclick="window.removeEducation(${edu.id})" class="absolute top-2 right-2 text-gray-400 hover:text-red-500 p-1">
                        <i data-lucide="trash-2" class="h-4 w-4"></i>
                    </button>
                    <div class="space-y-2">
                        <input type="text" placeholder="School" value="${edu.school}" oninput="window.updateEducation(${edu.id}, 'school', this.value)" class="block w-full rounded border-gray-300 text-sm p-1.5 border">
                        <input type="text" placeholder="Degree" value="${edu.degree}" oninput="window.updateEducation(${edu.id}, 'degree', this.value)" class="block w-full rounded border-gray-300 text-sm p-1.5 border">
                        <div class="grid grid-cols-2 gap-2">
                            <input type="text" placeholder="Start" value="${edu.startDate}" oninput="window.updateEducation(${edu.id}, 'startDate', this.value)" class="block w-full rounded border-gray-300 text-sm p-1.5 border">
                            <input type="text" placeholder="End" value="${edu.endDate}" oninput="window.updateEducation(${edu.id}, 'endDate', this.value)" class="block w-full rounded border-gray-300 text-sm p-1.5 border">
                        </div>
                    </div>
                </div>
            `).join('');
            if(window.lucide) lucide.createIcons();
        }

        // --- PREVIEW RENDER ---
        function renderPreview() {
            const { personal, experience, education, skills } = appState.data;
            const theme = appState.theme;
            const thColor = colors[theme];
            const thIcon = iconColors[theme];
            const thBg = bgColors[theme];
            const thHeaderBg = headerBgColors[theme];
            
            // Icons
            const iMap = (n) => `<i data-lucide="${n}" class="inline-block w-3 h-3 mr-1 align-text-bottom"></i>`;
            const iMapLg = (n) => `<i data-lucide="${n}" class="inline-block w-4 h-4 mt-0.5 ${thIcon}"></i>`;
            const iMapW = (n) => `<i data-lucide="${n}" class="inline-block w-3 h-3 mr-1 opacity-75"></i>`;

            const imgTag = personal.photoUrl ? `<img src="${personal.photoUrl}" class="w-full h-full object-cover" />` : '';

            let html = '';

            // MODERN
            if (appState.layout === 'modern') {
                html = `
                    <div class="flex h-full text-left bg-white min-h-[1000px]">
                        <div class="w-[32%] ${thBg} p-5 flex flex-col gap-6 pt-8">
                            ${personal.photoUrl ? `<div class="w-28 h-28 mx-auto rounded-full overflow-hidden border-4 border-white shadow-sm mb-2">${imgTag}</div>` : ''}
                            
                            <div>
                                <h3 class="text-xs font-bold uppercase tracking-wider mb-3 border-b-2 ${thColor} pb-1">Contact</h3>
                                <div class="flex flex-col gap-2 text-xs text-gray-700 break-words">
                                    ${personal.email ? `<div class="flex items-start gap-1.5">${iMapLg('mail')}<span>${personal.email}</span></div>` : ''}
                                    ${personal.phone ? `<div class="flex items-start gap-1.5">${iMapLg('phone')}<span>${personal.phone}</span></div>` : ''}
                                    ${personal.address ? `<div class="flex items-start gap-1.5">${iMapLg('map-pin')}<span>${personal.address}</span></div>` : ''}
                                    ${personal.linkedin ? `<div class="flex items-start gap-1.5">${iMapLg('linkedin')}<span>Linkedin</span></div>` : ''}
                                    ${personal.github ? `<div class="flex items-start gap-1.5">${iMapLg('github')}<span>Github</span></div>` : ''}
                                </div>
                            </div>

                            ${education.length ? `
                            <div>
                                <h3 class="text-xs font-bold uppercase tracking-wider mb-3 border-b-2 ${thColor} pb-1">Education</h3>
                                <div class="space-y-3">
                                    ${education.map(e => `
                                        <div>
                                            <div class="font-bold text-gray-900 text-xs">${e.school}</div>
                                            <div class="text-[10px] text-gray-600">${e.degree}</div>
                                            <div class="text-[10px] text-gray-500">${e.startDate} - ${e.endDate}</div>
                                        </div>
                                    `).join('')}
                                </div>
                            </div>` : ''}

                            ${skills ? `
                            <div>
                                <h3 class="text-xs font-bold uppercase tracking-wider mb-3 border-b-2 ${thColor} pb-1">Skills</h3>
                                <div class="flex flex-wrap gap-1.5">
                                    ${skills.split(',').map(s => `<span class="text-[10px] font-medium px-2 py-0.5 bg-white rounded border border-gray-200 text-gray-700">${s.trim()}</span>`).join('')}
                                </div>
                            </div>` : ''}
                        </div>

                        <div class="w-[68%] p-8 bg-white">
                            <div class="mb-6">
                                <h1 class="text-3xl font-bold uppercase tracking-wide leading-none ${thIcon}">${personal.fullName}</h1>
                                <p class="text-lg text-gray-600 font-medium mt-1">${personal.title}</p>
                            </div>

                            ${personal.summary ? `
                            <div class="mb-6">
                                <h3 class="text-xs font-bold uppercase tracking-wider mb-2 ${thIcon}">Profile</h3>
                                <p class="text-sm text-gray-700 leading-relaxed">${personal.summary}</p>
                            </div>` : ''}

                            ${experience.length ? `
                            <div>
                                <h3 class="text-xs font-bold uppercase tracking-wider mb-4 ${thIcon}">Experience</h3>
                                <div class="space-y-5">
                                    ${experience.map(e => `
                                        <div class="relative border-l-2 border-gray-200 pl-4 ml-1">
                                            <div class="absolute -left-[5px] top-1.5 h-2.5 w-2.5 rounded-full bg-gray-300"></div>
                                            <div class="mb-1">
                                                <h4 class="font-bold text-gray-900 text-sm">${e.role}</h4>
                                                <div class="flex justify-between items-center mt-0.5">
                                                    <span class="text-xs font-semibold text-gray-700">${e.company}</span>
                                                    <span class="text-[10px] text-gray-500 italic">${e.startDate} – ${e.endDate}</span>
                                                </div>
                                            </div>
                                            <p class="text-xs text-gray-600 leading-relaxed">${e.description}</p>
                                        </div>
                                    `).join('')}
                                </div>
                            </div>` : ''}
                        </div>
                    </div>
                `;
            }
            
            // CLASSIC
            else if (appState.layout === 'classic') {
                html = `
                    <div class="p-8 md:p-12 h-full flex flex-col text-left font-serif bg-white min-h-[1000px]">
                        <div class="border-b-2 pb-5 mb-5 ${thColor} flex justify-between items-start">
                            <div class="flex-1">
                                <h1 class="text-3xl font-bold text-gray-900 uppercase tracking-wide">${personal.fullName}</h1>
                                <p class="text-lg font-medium mt-1 ${thIcon}">${personal.title}</p>
                                <div class="flex flex-wrap gap-x-4 gap-y-1 mt-3 text-xs text-gray-600">
                                    ${personal.email ? `<span>${iMap('mail')}${personal.email}</span>` : ''}
                                    ${personal.phone ? `<span>${iMap('phone')}${personal.phone}</span>` : ''}
                                    ${personal.address ? `<span>${iMap('map-pin')}${personal.address}</span>` : ''}
                                </div>
                            </div>
                            ${personal.photoUrl ? `<div class="w-24 h-24 ml-4 rounded-full overflow-hidden border-2 ${thColor.split(' ')[1]}">${imgTag}</div>` : ''}
                        </div>

                        ${personal.summary ? `
                        <div class="mb-5">
                            <h3 class="text-xs font-bold uppercase tracking-wider mb-2 border-b ${thColor} pb-1">Summary</h3>
                            <p class="text-sm text-gray-700 leading-relaxed">${personal.summary}</p>
                        </div>` : ''}

                        ${experience.length ? `
                        <div class="mb-5">
                            <h3 class="text-xs font-bold uppercase tracking-wider mb-3 border-b ${thColor} pb-1">Experience</h3>
                            <div class="space-y-4">
                                ${experience.map(e => `
                                    <div>
                                        <div class="flex justify-between items-baseline">
                                            <h4 class="font-bold text-gray-900 text-sm">${e.role}</h4>
                                            <span class="text-[10px] text-gray-500 whitespace-nowrap">${e.startDate} – ${e.endDate}</span>
                                        </div>
                                        <div class="text-xs font-medium mb-1 ${thIcon}">${e.company}</div>
                                        <p class="text-xs text-gray-700 leading-relaxed">${e.description}</p>
                                    </div>
                                `).join('')}
                            </div>
                        </div>` : ''}

                        ${education.length ? `
                        <div class="mb-5">
                            <h3 class="text-xs font-bold uppercase tracking-wider mb-3 border-b ${thColor} pb-1">Education</h3>
                            <div class="space-y-2">
                                ${education.map(e => `
                                    <div>
                                        <div class="flex justify-between items-baseline">
                                            <h4 class="font-bold text-gray-900 text-sm">${e.school}</h4>
                                            <span class="text-[10px] text-gray-500">${e.startDate} – ${e.endDate}</span>
                                        </div>
                                        <div class="text-xs ${thIcon}">${e.degree}</div>
                                    </div>
                                `).join('')}
                            </div>
                        </div>` : ''}

                        ${skills ? `
                        <div>
                            <h3 class="text-xs font-bold uppercase tracking-wider mb-2 border-b ${thColor} pb-1">Skills</h3>
                            <div class="flex flex-wrap gap-2">
                                ${skills.split(',').map(s => `<span class="text-[10px] font-medium px-2 py-0.5 rounded-full ${thBg} text-gray-800">${s.trim()}</span>`).join('')}
                            </div>
                        </div>` : ''}
                    </div>
                `;
            }

            // MINIMALIST
            else if (appState.layout === 'minimalist') {
                html = `
                    <div class="p-10 h-full flex flex-col text-left bg-white font-sans text-gray-800 min-h-[1000px]">
                        <div class="text-center mb-8">
                            ${personal.photoUrl ? `<div class="w-20 h-20 mx-auto rounded-full overflow-hidden mb-3 border border-gray-200">${imgTag}</div>` : ''}
                            <h1 class="text-2xl font-light tracking-[0.2em] uppercase text-gray-900 mb-2">${personal.fullName}</h1>
                            <p class="text-xs uppercase tracking-wide text-gray-500 mb-3">${personal.title}</p>
                            <div class="flex flex-wrap justify-center gap-3 text-[10px] text-gray-500 uppercase tracking-wider">
                                ${personal.email ? `<span>${personal.email}</span>` : ''}
                                ${personal.phone ? `<span class="border-l border-gray-300 pl-3">${personal.phone}</span>` : ''}
                                ${personal.address ? `<span class="border-l border-gray-300 pl-3">${personal.address}</span>` : ''}
                            </div>
                        </div>

                        ${personal.summary ? `
                        <div class="mb-8 max-w-lg mx-auto text-center">
                            <p class="text-xs text-gray-600 leading-relaxed italic">${personal.summary}</p>
                        </div>` : ''}

                        <div class="space-y-8">
                            ${experience.length ? `
                            <section>
                                <h3 class="text-[10px] font-bold uppercase tracking-[0.15em] text-gray-400 mb-4 text-center">Experience</h3>
                                <div class="space-y-4">
                                    ${experience.map(e => `
                                        <div class="grid grid-cols-12 gap-3">
                                            <div class="col-span-3 text-right pt-0.5">
                                                <span class="text-[10px] text-gray-500 block">${e.startDate}</span>
                                                <span class="text-[10px] text-gray-400 block">${e.endDate}</span>
                                            </div>
                                            <div class="col-span-9 border-l border-gray-200 pl-4 pb-2">
                                                <h4 class="font-bold text-xs text-gray-800">${e.role}</h4>
                                                <div class="text-[10px] text-gray-500 mb-1 uppercase tracking-wide">${e.company}</div>
                                                <p class="text-[11px] text-gray-600 leading-relaxed">${e.description}</p>
                                            </div>
                                        </div>
                                    `).join('')}
                                </div>
                            </section>` : ''}

                            ${education.length ? `
                            <section>
                                <h3 class="text-[10px] font-bold uppercase tracking-[0.15em] text-gray-400 mb-4 text-center">Education</h3>
                                <div class="space-y-3">
                                    ${education.map(e => `
                                        <div class="grid grid-cols-12 gap-3">
                                            <div class="col-span-3 text-right">
                                                <span class="text-[10px] text-gray-500">${e.startDate}-${e.endDate}</span>
                                            </div>
                                            <div class="col-span-9 border-l border-gray-200 pl-4">
                                                <h4 class="font-bold text-xs text-gray-800">${e.school}</h4>
                                                <div class="text-[10px] text-gray-500">${e.degree}</div>
                                            </div>
                                        </div>
                                    `).join('')}
                                </div>
                            </section>` : ''}

                             ${skills ? `
                            <section>
                                <h3 class="text-[10px] font-bold uppercase tracking-[0.15em] text-gray-400 mb-3 text-center">Skills</h3>
                                <div class="text-center max-w-md mx-auto">
                                    <p class="text-[11px] text-gray-600 leading-relaxed">${skills.split(',').join(' • ')}</p>
                                </div>
                            </section>` : ''}
                        </div>
                    </div>
                `;
            }

            // PROFESSIONAL
            else if (appState.layout === 'professional') {
                html = `
                    <div class="h-full flex flex-col text-left bg-white font-sans min-h-[1000px]">
                        <div class="${thHeaderBg} text-white p-8 flex justify-between items-center shadow-md">
                            <div>
                                <h1 class="text-3xl font-bold tracking-tight">${personal.fullName}</h1>
                                <p class="text-lg opacity-90 font-light mt-1">${personal.title}</p>
                            </div>
                            ${personal.photoUrl ? `<div class="w-24 h-24 rounded bg-white p-1 shadow-sm"><img src="${personal.photoUrl}" class="w-full h-full object-cover rounded-sm" /></div>` : ''}
                        </div>
                        
                        <div class="bg-gray-800 text-gray-300 px-8 py-2.5 text-[10px] flex flex-wrap gap-4 items-center">
                             ${personal.email ? `<div class="flex items-center gap-1">${iMapW('mail')}${personal.email}</div>` : ''}
                             ${personal.phone ? `<div class="flex items-center gap-1">${iMapW('phone')}${personal.phone}</div>` : ''}
                             ${personal.address ? `<div class="flex items-center gap-1">${iMapW('map-pin')}${personal.address}</div>` : ''}
                        </div>

                        <div class="flex flex-1">
                            <div class="w-2/3 p-8 pr-6">
                                ${personal.summary ? `
                                <div class="mb-6">
                                    <h3 class="text-xs font-bold uppercase text-gray-900 mb-2 flex items-center gap-2"><span class="${thBg} w-6 h-1 block"></span> Profile</h3>
                                    <p class="text-xs text-gray-700 leading-relaxed text-justify">${personal.summary}</p>
                                </div>` : ''}

                                ${experience.length ? `
                                <div class="mb-6">
                                    <h3 class="text-xs font-bold uppercase text-gray-900 mb-4 flex items-center gap-2"><span class="${thBg} w-6 h-1 block"></span> Work Experience</h3>
                                    <div class="space-y-5">
                                        ${experience.map(e => `
                                            <div>
                                                <h4 class="font-bold text-gray-800 text-sm">${e.role}</h4>
                                                <div class="text-xs ${thIcon} font-medium mb-1">${e.company}</div>
                                                <p class="text-xs text-gray-600 mt-1 leading-relaxed">${e.description}</p>
                                            </div>
                                        `).join('')}
                                    </div>
                                </div>` : ''}
                            </div>

                            <div class="w-1/3 bg-gray-50 p-6 border-l border-gray-100">
                                ${experience.length ? `
                                <div class="mb-6">
                                    <h3 class="text-[10px] font-bold uppercase text-gray-500 mb-3 tracking-wider">History</h3>
                                    <div class="space-y-3">
                                        ${experience.map(e => `
                                            <div class="text-[10px]">
                                                <div class="font-bold text-gray-700">${e.company}</div>
                                                <div class="text-gray-500">${e.startDate}-${e.endDate}</div>
                                            </div>
                                        `).join('')}
                                    </div>
                                </div>` : ''}

                                ${education.length ? `
                                <div class="mb-6">
                                    <h3 class="text-[10px] font-bold uppercase text-gray-500 mb-3 tracking-wider">Education</h3>
                                    <div class="space-y-3">
                                        ${education.map(e => `
                                            <div>
                                                <div class="font-bold text-xs text-gray-800">${e.school}</div>
                                                <div class="text-[10px] ${thIcon} font-medium">${e.degree}</div>
                                                <div class="text-[10px] text-gray-500 mt-0.5">${e.startDate}-${e.endDate}</div>
                                            </div>
                                        `).join('')}
                                    </div>
                                </div>` : ''}

                                ${skills ? `
                                <div>
                                    <h3 class="text-[10px] font-bold uppercase text-gray-500 mb-3 tracking-wider">Skills</h3>
                                    <div class="flex flex-col gap-1.5">
                                        ${skills.split(',').map(s => `
                                            <div class="flex items-center gap-2">
                                                <div class="h-1 w-1 rounded-full ${thHeaderBg}"></div>
                                                <span class="text-xs text-gray-700">${s.trim()}</span>
                                            </div>
                                        `).join('')}
                                    </div>
                                </div>` : ''}
                            </div>
                        </div>
                    </div>
                `;
            }

            document.getElementById('resume-preview-container').innerHTML = html;
            if(window.lucide) lucide.createIcons();
        }

        // --- GLOBAL ACTIONS ---
        window.handleImageUpload = (input) => {
            if (input.files && input.files[0]) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    appState.data.personal.photoUrl = e.target.result;
                    document.getElementById('image-preview-mini').innerHTML = `<img src="${e.target.result}" class="w-full h-full object-cover" />`;
                    renderPreview();
                    window.triggerAutoSave();
                };
                reader.readAsDataURL(input.files[0]);
            }
        };

        window.updatePersonal = (f, v) => { appState.data.personal[f] = v; renderPreview(); window.triggerAutoSave(); };
        window.updateExperience = (id, f, v) => { 
            const e = appState.data.experience.find(x => x.id === id); 
            if(e) { e[f] = v; renderPreview(); window.triggerAutoSave(); }
        };
        window.addExperience = () => { 
            appState.data.experience.push({ id: Date.now(), company: '', role: '', startDate: '', endDate: '', description: '' }); 
            renderExperienceList(); renderPreview(); window.triggerAutoSave();
        };
        window.removeExperience = (id) => {
            appState.data.experience = appState.data.experience.filter(e => e.id !== id);
            renderExperienceList(); renderPreview(); window.triggerAutoSave();
        };
        window.updateEducation = (id, f, v) => {
            const e = appState.data.education.find(x => x.id === id);
            if(e) { e[f] = v; renderPreview(); window.triggerAutoSave(); }
        };
        window.addEducation = () => {
            appState.data.education.push({ id: Date.now(), school: '', degree: '', startDate: '', endDate: '', location: '' });
            renderEducationList(); renderPreview(); window.triggerAutoSave();
        };
        window.removeEducation = (id) => {
            appState.data.education = appState.data.education.filter(e => e.id !== id);
            renderEducationList(); renderPreview(); window.triggerAutoSave();
        };
        window.handleSkillsChange = (v) => { appState.data.skills = v; renderPreview(); window.triggerAutoSave(); };
        window.handleLayoutChange = (v) => { appState.layout = v; renderPreview(); window.triggerAutoSave(); };
        window.handleThemeChange = (v) => { appState.theme = v; renderColorPickers(); renderPreview(); window.triggerAutoSave(); };
        window.switchTab = (t) => {
            document.getElementById('editor-section').className = t === 'editor' ? 'w-full h-full overflow-y-auto custom-scroll p-4 pb-24 space-y-6 bg-gray-50' : 'hidden';
            document.getElementById('preview-section').className = t === 'preview' ? 'w-full h-full overflow-y-auto custom-scroll bg-gray-200/50 p-4' : 'hidden';
            
            // Tab Styles
            document.getElementById('tab-editor').className = t === 'editor' ? 'flex-1 py-3 text-sm font-medium text-center border-b-2 border-blue-600 text-blue-600' : 'flex-1 py-3 text-sm font-medium text-center border-b-2 border-transparent text-gray-500';
            document.getElementById('tab-preview').className = t === 'preview' ? 'flex-1 py-3 text-sm font-medium text-center border-b-2 border-blue-600 text-blue-600' : 'flex-1 py-3 text-sm font-medium text-center border-b-2 border-transparent text-gray-500';
        };

        window.reInit = init;
        init();
    </script>
</body>
</html>
