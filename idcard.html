<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Pro ID Studio Ultimate</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <!-- Interact.js -->
    <script src="https://cdn.jsdelivr.net/npm/interactjs/dist/interact.min.js"></script>
    <!-- Barcode Lib -->
    <script src="https://cdn.jsdelivr.net/npm/jsbarcode@3.11.5/dist/JsBarcode.all.min.js"></script>
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700;800&family=Montserrat:wght@400;600;800&family=Open+Sans:wght@400;600&display=swap" rel="stylesheet">
    
    <style>
        body { font-family: 'Inter', sans-serif; overscroll-behavior: none; }
        
        /* --- Editor Area --- */
        .canvas-bg {
            background-color: #f1f5f9;
            background-image: linear-gradient(#cbd5e1 1px, transparent 1px), linear-gradient(90deg, #cbd5e1 1px, transparent 1px);
            background-size: 20px 20px;
            overflow: auto; /* Allow scrolling if card is too big */
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
            padding: 20px;
        }

        /* --- The Card --- */
        .card-stage {
            position: relative;
            background: white;
            box-shadow: 0 20px 40px -5px rgba(0, 0, 0, 0.15);
            /* Base Editing Resolution (High Quality) */
            width: 600px; 
            height: 378px;
            overflow: hidden;
            transform-origin: center;
            touch-action: none;
            flex-shrink: 0; /* Prevent shrinking in flex container */
        }
        .card-stage.portrait { width: 378px; height: 600px; }

        /* --- Elements --- */
        .element {
            position: absolute;
            display: flex;
            align-items: center;
            justify-content: center;
            box-sizing: border-box;
            user-select: none;
            cursor: grab;
        }
        
        .element:hover { outline: 1px dashed rgba(59, 130, 246, 0.5); }
        .element.selected { 
            outline: 2px solid #2563eb; 
            z-index: 1000 !important;
        }

        .element[data-type="text"] {
            white-space: pre-wrap;
            padding: 4px;
            line-height: 1.2;
            cursor: text;
            height: auto !important;
        }
        .element img, .element svg {
            width: 100%;
            height: 100%;
            object-fit: cover;
            pointer-events: none;
            display: block;
        }
        
        /* Resize Handles */
        .resize-handle {
            display: none;
            position: absolute;
            width: 12px;
            height: 12px;
            background: #2563eb;
            border: 2px solid white;
            bottom: -6px; right: -6px;
            cursor: nwse-resize;
            border-radius: 50%;
            z-index: 9999;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }
        .element.selected .resize-handle { display: block; }

        /* --- RESPONSIVE LAYOUT --- */
        @media (max-width: 768px) {
            .app-layout { flex-direction: column; }
            .sidebar-tools { order: 2; width: 100%; height: auto; min-height: 200px; border-right: none; border-top: 1px solid #e2e8f0; }
            .main-canvas { order: 1; flex: 1; min-height: 50vh; overflow: hidden; } /* Ensure canvas area is scrollable/scalable */
            /* Properties panel mobile view */
            .sidebar-props { 
                position: fixed; 
                bottom: 0; 
                left: 0; 
                width: 100%; 
                height: 60vh; 
                z-index: 100; 
                transform: translateY(100%); 
                transition: transform 0.3s; 
                box-shadow: 0 -4px 20px rgba(0,0,0,0.1); 
            }
            .sidebar-props.open { transform: translateY(0); }
        }

        /* --- PRINT CSS --- */
        @media print {
            @page { size: A4; margin: 5mm; }
            html, body { margin: 0 !important; padding: 0 !important; height: 100%; }
            body * { visibility: hidden; }
            
            #print-area, #print-area * { visibility: visible; }
            #print-area {
                position: absolute; top: 0; left: 0; width: 100%;
                display: flex; flex-wrap: wrap; gap: 2mm;
                padding: 5mm;
                justify-content: flex-start; align-content: flex-start;
            }

            .print-card-wrapper {
                position: relative; overflow: hidden;
                width: 85.6mm !important; height: 54mm !important;
                border: 1px dashed #94a3b8; background: white;
                page-break-inside: avoid; break-inside: avoid;
                flex-shrink: 0 !important; 
                -webkit-print-color-adjust: exact !important;
                print-color-adjust: exact !important;
            }
            .print-card-wrapper.portrait { width: 54mm !important; height: 85.6mm !important; }

            .print-card-content {
                width: 600px; height: 378px;
                transform-origin: top left; transform: scale(0.539);
            }
            .print-card-wrapper.portrait .print-card-content {
                width: 378px; height: 600px; transform: scale(0.539);
            }

            .element { outline: none !important; }
            .resize-handle { display: none !important; }
        }
    </style>
</head>
<body class="bg-white h-screen flex flex-col text-slate-800">

    <input type="file" id="global-img-input" class="hidden" accept="image/*">

    <!-- Navbar -->
    <nav class="bg-white border-b border-slate-200 px-4 py-2 flex items-center justify-between z-50 shrink-0">
        <div class="flex items-center gap-2">
            <div class="bg-blue-600 p-1.5 rounded-lg text-white"><i data-lucide="id-card" class="w-5 h-5"></i></div>
            <span class="font-bold text-lg hidden sm:inline">ID Studio</span>
        </div>
        <div class="flex gap-2">
            <button onclick="addToQueue()" class="flex items-center gap-1 px-3 py-1.5 bg-emerald-600 text-white rounded text-xs font-bold hover:bg-emerald-700">
                <i data-lucide="plus" class="w-3 h-3"></i> <span class="hidden sm:inline">Add</span>
            </button>
            <button onclick="window.print()" class="flex items-center gap-1 px-3 py-1.5 bg-slate-800 text-white rounded text-xs font-bold hover:bg-slate-900">
                <i data-lucide="printer" class="w-3 h-3"></i> <span id="queue-count">0</span>
            </button>
        </div>
    </nav>

    <div class="flex flex-1 overflow-hidden app-layout">
        
        <!-- LEFT: Templates & Tools -->
        <div class="sidebar-tools w-72 bg-white border-r border-slate-200 flex flex-col z-30">
            <div class="flex border-b border-slate-100">
                <button onclick="switchTab('templates')" class="flex-1 py-3 text-xs font-bold text-slate-600 border-b-2 border-blue-600 bg-blue-50" id="tab-templates">Templates</button>
                <button onclick="switchTab('queue')" class="flex-1 py-3 text-xs font-bold text-slate-400 hover:text-slate-600" id="tab-queue">Print Queue</button>
            </div>

            <!-- Templates Tab -->
            <div id="panel-templates" class="flex-1 flex flex-col overflow-hidden">
                <div class="p-3 overflow-y-auto grid grid-cols-2 gap-2">
                    <!-- Injected via JS -->
                </div>
            </div>

            <!-- Queue Tab -->
            <div id="panel-queue" class="hidden flex-1 flex flex-col overflow-hidden">
                <div id="queue-list" class="flex-1 overflow-y-auto p-2 space-y-2"></div>
                <div class="p-2 border-t">
                    <button onclick="clearQueue()" class="w-full py-2 text-xs text-red-500 border border-red-200 rounded hover:bg-red-50">Clear All</button>
                </div>
            </div>

            <!-- Bottom Tools -->
            <div class="p-3 border-t border-slate-100 bg-slate-50 grid grid-cols-4 gap-1">
                <button onclick="addNewText()" class="flex flex-col items-center p-2 bg-white border rounded hover:border-blue-500"><i data-lucide="type" class="w-4 h-4"></i><span class="text-[9px]">Text</span></button>
                <label class="flex flex-col items-center p-2 bg-white border rounded hover:border-blue-500 cursor-pointer">
                    <input type="file" class="hidden" onchange="addNewImage(event)"><i data-lucide="image" class="w-4 h-4"></i><span class="text-[9px]">Img</span>
                </label>
                <button onclick="addShape('rect')" class="flex flex-col items-center p-2 bg-white border rounded hover:border-blue-500"><i data-lucide="square" class="w-4 h-4"></i><span class="text-[9px]">Box</span></button>
                <button onclick="addNewBarcode()" class="flex flex-col items-center p-2 bg-white border rounded hover:border-blue-500"><i data-lucide="scan-barcode" class="w-4 h-4"></i><span class="text-[9px]">Code</span></button>
            </div>
        </div>

        <!-- CENTER: Canvas -->
        <div class="main-canvas flex-1 bg-slate-100 relative flex flex-col overflow-hidden">
            <div class="absolute top-2 left-2 z-10 bg-white/80 px-2 py-1 rounded text-[10px] shadow backdrop-blur">
                Scale: <span id="scale-val">100%</span>
            </div>
            
            <div class="flex-1 canvas-bg" id="canvas-wrapper" onclick="deselectAll(event)">
                <div id="card" class="card-stage bg-white shadow-2xl" onclick="event.stopPropagation()"></div>
            </div>
        </div>

        <!-- RIGHT/BOTTOM: Properties -->
        <div id="prop-panel" class="sidebar-props w-72 bg-white border-l border-slate-200 flex flex-col z-40">
            <div class="p-3 border-b border-slate-100 flex justify-between items-center bg-slate-50">
                <h3 class="text-xs font-bold text-slate-500 uppercase">Properties</h3>
                <div class="flex gap-1">
                    <button onclick="changeLayer('up')" class="p-1 hover:bg-white rounded"><i data-lucide="arrow-up" class="w-4 h-4"></i></button>
                    <button onclick="changeLayer('down')" class="p-1 hover:bg-white rounded"><i data-lucide="arrow-down" class="w-4 h-4"></i></button>
                    <button onclick="deleteSelected()" class="p-1 text-red-500 hover:bg-red-50 rounded"><i data-lucide="trash-2" class="w-4 h-4"></i></button>
                    <button onclick="closeProps()" class="md:hidden p-1 ml-2"><i data-lucide="x" class="w-4 h-4"></i></button>
                </div>
            </div>

            <div id="empty-state" class="flex-1 flex flex-col items-center justify-center p-6 text-slate-400 text-xs text-center">
                Select an element to edit
            </div>

            <div id="controls" class="hidden flex-1 overflow-y-auto p-4 space-y-4">
                
                <!-- Text Inputs -->
                <div id="text-inputs" class="hidden space-y-3">
                    <textarea id="prop-text" class="w-full text-sm p-2 border rounded" rows="2" oninput="updateElement('text')"></textarea>
                    <div class="flex gap-2">
                        <input type="number" id="prop-size" class="w-16 text-sm p-1 border rounded" oninput="updateElement('size')">
                        <input type="color" id="prop-color" class="w-8 h-8 p-0 border-0 rounded cursor-pointer" oninput="updateElement('color')">
                        <div class="flex-1 flex justify-end gap-1">
                            <button onclick="toggleStyle('bold')" class="p-1 border rounded hover:bg-slate-50"><b>B</b></button>
                            <button onclick="updateElement('align', 'center')" class="p-1 border rounded hover:bg-slate-50"><i data-lucide="align-center" class="w-4 h-4"></i></button>
                        </div>
                    </div>
                </div>

                <!-- Visual (Img/Shape) -->
                <div id="visual-inputs" class="hidden space-y-3">
                    <button onclick="triggerReplace()" id="btn-replace" class="w-full py-1.5 bg-blue-50 text-blue-600 border border-blue-100 rounded text-xs font-bold">Replace Image</button>
                    
                    <div class="flex items-center justify-between">
                        <label class="text-[10px] font-bold text-slate-400 uppercase">Fill</label>
                        <input type="color" id="prop-fill" class="w-6 h-6 border-0 p-0 rounded cursor-pointer" oninput="updateElement('bg')">
                    </div>
                    
                    <div>
                        <label class="text-[10px] font-bold text-slate-400 uppercase">Roundness</label>
                        <input type="range" id="prop-radius" min="0" max="50" class="w-full accent-blue-600" oninput="updateElement('radius_slider')">
                    </div>
                    
                    <div>
                        <label class="text-[10px] font-bold text-slate-400 uppercase">Border</label>
                        <div class="flex gap-2">
                            <input type="number" id="prop-border-w" class="w-12 text-sm p-1 border rounded" placeholder="0" oninput="updateElement('border')">
                            <input type="color" id="prop-border-c" class="w-6 h-6 border-0 p-0 rounded cursor-pointer self-center" oninput="updateElement('border')">
                        </div>
                    </div>
                </div>

                <!-- Barcode/QR -->
                <div id="code-inputs" class="hidden space-y-2">
                    <label class="text-[10px] font-bold text-slate-400 uppercase">Code Value</label>
                    <input type="text" id="prop-code" class="w-full text-sm p-2 border rounded" oninput="updateElement('code')">
                    <div class="flex gap-2 mt-2">
                        <button onclick="setCodeType('qr')" class="flex-1 py-1 text-xs border rounded hover:bg-slate-50">QR</button>
                        <button onclick="setCodeType('bar')" class="flex-1 py-1 text-xs border rounded hover:bg-slate-50">Barcode</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Hidden Print Area -->
    <div id="print-area"></div>

    <script>
        let selectedEl = null;
        let queue = [];
        let zIndexCounter = 100;
        const card = document.getElementById('card');
        const imgInput = document.getElementById('global-img-input');

        // --- TEMPLATES (Based on User Images) ---
        const TEMPLATES = [
            {
                id: 't1_red', name: 'Ginyard Red', portrait: true, elements: [
                    { type: 'shape', bg: '#450a0a', w: '100%', h: '100%', x: 0, y: 0, z: 1 },
                    { type: 'shape', bg: '#ffffff', w: '100%', h: '450px', x: 0, y: 150, z: 2, clip: 'polygon(0 15%, 100% 0, 100% 100%, 0 85%)' },
                    { type: 'text', text: 'GINYARD', size: 28, color: '#fff', bold: true, x: 110, y: 40, z: 10 },
                    { type: 'text', text: 'International Co.', size: 14, color: '#fca5a5', x: 110, y: 75, z: 10 },
                    { type: 'image', src: 'https://api.dicebear.com/7.x/avataaars/svg?seed=Jack', w: 150, h: 150, x: 114, y: 130, z: 10, rounded: '50%', border: '4px solid #dc2626' },
                    { type: 'text', text: 'MORGAN MAXWELL', size: 30, color: '#000', bold: true, align: 'center', w: '100%', x: 0, y: 330, z: 10 },
                    { type: 'text', text: 'DIRECTOR', size: 16, color: '#4b5563', align: 'center', w: '100%', x: 0, y: 370, z: 10 },
                    { type: 'barcode', value: '1234567890', w: 250, h: 60, x: 64, y: 410, z: 10 },
                    { type: 'shape', bg: '#dc2626', w: '100%', h: '25px', x: 0, y: 550, z: 3 }
                ]
            },
            {
                id: 't2_blue', name: 'Brocelle State', portrait: false, elements: [
                    { type: 'shape', bg: '#ffffff', w: '100%', h: '100%', x: 0, y: 0, z: 1 },
                    { type: 'shape', bg: '#0f172a', w: '100%', h: '60px', x: 0, y: 0, z: 2 },
                    { type: 'shape', bg: '#0f172a', w: '100%', h: '40px', x: 0, y: 338, z: 2 },
                    { type: 'text', text: 'UNITED STATE OF BROCELLE', size: 26, color: '#fff', bold: true, align: 'right', w: '580px', x: 0, y: 15, z: 10 },
                    { type: 'image', src: 'https://api.dicebear.com/7.x/avataaars/svg?seed=Felix', w: 140, h: 160, x: 420, y: 120, z: 10, rounded: '8px' },
                    { type: 'text', text: 'Name   : Itsuki Takahashi', size: 18, color: '#334155', x: 40, y: 100, z: 10 },
                    { type: 'text', text: 'D.O.B   : 02.01.1991', size: 18, color: '#334155', x: 40, y: 130, z: 10 },
                    { type: 'text', text: 'Address: 123 Anywhere St.', size: 18, color: '#334155', x: 40, y: 160, z: 10 },
                    { type: 'barcode', value: '123-456-7890', w: 200, h: 50, x: 390, y: 290, z: 10 },
                    { type: 'text', text: 'Permanent Resident', size: 14, color: '#fff', align: 'right', w: '580px', x: 0, y: 40, z: 10 }
                ]
            },
            {
                id: 't3_green', name: 'Salford Student', portrait: false, elements: [
                    { type: 'shape', bg: '#f0fdf4', w: '100%', h: '100%', x: 0, y: 0, z: 1 },
                    { type: 'shape', bg: '#064e3b', w: '280px', h: '60px', x: 0, y: 40, z: 2, rounded: '0 30px 30px 0' },
                    { type: 'text', text: 'STUDENT ID CARD', size: 22, color: '#fff', bold: true, x: 20, y: 55, z: 10 },
                    { type: 'shape', bg: '#ffffff', w: '140px', h: '140px', x: 40, y: 130, z: 5, border: '2px solid #064e3b', rounded: '20px' },
                    { type: 'image', src: 'https://api.dicebear.com/7.x/avataaars/svg?seed=Matt', w: 120, h: 120, x: 50, y: 140, z: 10, rounded: '12px' },
                    { type: 'text', text: 'MATT ZHANG', size: 24, color: '#000', bold: true, x: 220, y: 140, z: 10 },
                    { type: 'text', text: 'ID: 123-456-7890', size: 18, color: '#4b5563', x: 220, y: 180, z: 10 },
                    { type: 'barcode', value: '12345678', w: 150, h: 40, x: 40, y: 290, z: 10 },
                    { type: 'shape', bg: '#064e3b', w: '100%', h: '30px', x: 0, y: 348, z: 2 }
                ]
            },
            {
                id: 't4_wave', name: 'Studio Wave', portrait: true, elements: [
                    { type: 'shape', bg: '#fff', w: '100%', h: '100%', x: 0, y: 0, z: 1 },
                    { type: 'shape', bg: '#3b82f6', w: '100%', h: '120px', x: 0, y: 0, z: 2, clip: 'ellipse(100% 80% at 50% 0%)' },
                    { type: 'shape', bg: '#1e3a8a', w: '100%', h: '100px', x: 0, y: 500, z: 2, clip: 'ellipse(100% 100% at 50% 100%)' },
                    { type: 'image', src: 'https://api.dicebear.com/7.x/avataaars/svg?seed=Jeremy', w: 140, h: 140, x: 119, y: 120, z: 10, rounded: '50%', border: '4px solid #3b82f6' },
                    { type: 'text', text: 'JEREMY', size: 36, color: '#000', bold: true, align: 'center', w: '100%', x: 0, y: 280, z: 10 },
                    { type: 'text', text: 'DAVIS', size: 36, color: '#000', bold: true, align: 'center', w: '100%', x: 0, y: 320, z: 10 },
                    { type: 'text', text: 'PROJECT MANAGER', size: 16, color: '#64748b', align: 'center', w: '100%', x: 0, y: 370, z: 10 },
                    { type: 'barcode', value: '1234567890', w: 200, h: 50, x: 89, y: 420, z: 10 }
                ]
            }
        ];

        // --- INIT ---
        document.addEventListener('DOMContentLoaded', () => {
            lucide.createIcons();
            renderTemplatesList();
            loadTemplate('t1_red');
            setupInteract();
            setupAutoResize();
            
            imgInput.addEventListener('change', (e) => {
                if(e.target.files && e.target.files[0] && selectedEl) {
                    const reader = new FileReader();
                    reader.onload = (evt) => {
                        const img = selectedEl.querySelector('img');
                        if(img) img.src = evt.target.result;
                    };
                    reader.readAsDataURL(e.target.files[0]);
                }
                imgInput.value = '';
            });
        });

        // --- CANVAS SCALING (Mobile Fix) ---
        function setupAutoResize() {
            const resize = () => {
                const wrapper = document.getElementById('canvas-wrapper');
                const stage = document.getElementById('card');
                const padding = 20; // Slightly less padding for mobile
                
                const availW = wrapper.clientWidth - padding;
                const availH = wrapper.clientHeight - padding;
                const cardW = stage.offsetWidth;
                const cardH = stage.offsetHeight;
                
                // Calculate scale to fit
                const scale = Math.min(availW / cardW, availH / cardH, 1);
                
                stage.style.transform = `scale(${scale})`;
                document.getElementById('scale-val').innerText = Math.round(scale * 100) + '%';
            };
            window.addEventListener('resize', resize);
            setInterval(resize, 1000); 
            resize();
        }

        // --- LOGIC ---
        function renderTemplatesList() {
            const grid = document.getElementById('panel-templates').children[0];
            grid.innerHTML = '';
            TEMPLATES.forEach(tpl => {
                const btn = document.createElement('button');
                btn.className = 'flex flex-col items-center p-2 border rounded hover:border-blue-500 bg-white shadow-sm';
                btn.onclick = () => loadTemplate(tpl.id);
                // Simple CSS Preview
                const isP = tpl.portrait;
                const aspect = isP ? 'w-8 h-12' : 'w-12 h-8';
                const bg = tpl.elements[0]?.bg || '#eee';
                btn.innerHTML = `
                    <div class="${aspect} rounded border mb-1" style="background:${bg}"></div>
                    <span class="text-[10px] font-bold text-slate-600">${tpl.name}</span>
                `;
                grid.appendChild(btn);
            });
        }

        function switchTab(tab) {
            document.getElementById('tab-templates').className = tab === 'templates' ? 'flex-1 py-3 text-xs font-bold text-slate-600 border-b-2 border-blue-600 bg-blue-50' : 'flex-1 py-3 text-xs font-bold text-slate-400 hover:text-slate-600';
            document.getElementById('tab-queue').className = tab === 'queue' ? 'flex-1 py-3 text-xs font-bold text-slate-600 border-b-2 border-blue-600 bg-blue-50' : 'flex-1 py-3 text-xs font-bold text-slate-400 hover:text-slate-600';
            
            document.getElementById('panel-templates').style.display = tab === 'templates' ? 'flex' : 'none';
            document.getElementById('panel-queue').style.display = tab === 'queue' ? 'flex' : 'none';
        }

        function loadTemplate(id) {
            const tpl = TEMPLATES.find(t => t.id === id);
            card.innerHTML = '';
            card.className = tpl.portrait ? 'card-stage portrait bg-white shadow-2xl' : 'card-stage bg-white shadow-2xl';
            tpl.elements.forEach(data => createElement(data));
            deselectAll();
            // Force resize update
            setTimeout(() => window.dispatchEvent(new Event('resize')), 100);
        }

        function createElement(data) {
            const el = document.createElement('div');
            el.className = 'element';
            
            const x = data.x || 0;
            const y = data.y || 0;
            el.style.transform = `translate(${x}px, ${y}px)`;
            el.dataset.x = x;
            el.dataset.y = y;
            el.style.zIndex = data.z || zIndexCounter++;

            // Size
            if(data.w) el.style.width = data.w;
            if(data.h) el.style.height = data.h;

            if(data.type === 'text') {
                el.dataset.type = 'text';
                el.innerText = data.text;
                el.style.fontSize = (data.size || 24) + 'px';
                el.style.color = data.color || '#000';
                el.style.fontWeight = data.bold ? '700' : '400';
                if(data.align) el.style.textAlign = data.align;
                if(data.align === 'center') el.style.justifyContent = 'center';
                if(data.align === 'right') el.style.justifyContent = 'flex-end';
            }
            else if(data.type === 'image') {
                el.dataset.type = 'image';
                const img = document.createElement('img');
                img.src = data.src;
                if(data.rounded) img.style.borderRadius = data.rounded;
                if(data.border) img.style.border = data.border;
                el.appendChild(img);
                addHandle(el);
            }
            else if(data.type === 'shape') {
                el.dataset.type = 'shape';
                el.style.backgroundColor = data.bg;
                if(data.clip) el.style.clipPath = data.clip;
                if(data.rounded) el.style.borderRadius = data.rounded;
                if(data.border) el.style.border = data.border;
                addHandle(el);
            }
            else if(data.type === 'barcode' || data.type === 'qr') {
                el.dataset.type = 'code';
                el.dataset.codeType = data.type; // 'barcode' or 'qr'
                el.dataset.value = data.value;
                const img = document.createElement('img');
                el.appendChild(img);
                renderCode(el);
                addHandle(el);
            }

            el.addEventListener('mousedown', (e) => { e.stopPropagation(); selectElement(el); });
            el.addEventListener('touchstart', (e) => { e.stopPropagation(); selectElement(el); });
            card.appendChild(el);
        }

        function addHandle(el) {
            const h = document.createElement('div');
            h.className = 'resize-handle';
            el.appendChild(h);
        }

        function renderCode(el) {
            const img = el.querySelector('img');
            const val = el.dataset.value || '123';
            const type = el.dataset.codeType;
            
            if(type === 'qr') {
                img.src = `https://api.qrserver.com/v1/create-qr-code/?size=300x300&data=${encodeURIComponent(val)}`;
                img.style.objectFit = 'contain';
            } else {
                // Use JsBarcode
                const canvas = document.createElement('canvas');
                JsBarcode(canvas, val, { format: "CODE128", displayValue: false, margin: 0 });
                img.src = canvas.toDataURL();
                img.style.objectFit = 'fill';
            }
        }

        // --- INTERACTION ---
        function setupInteract() {
            interact('.element')
                .draggable({
                    listeners: { move(e) {
                        const t = e.target;
                        const x = (parseFloat(t.dataset.x)||0) + e.dx;
                        const y = (parseFloat(t.dataset.y)||0) + e.dy;
                        t.style.transform = `translate(${x}px, ${y}px)`;
                        t.dataset.x = x; t.dataset.y = y;
                        if(t !== selectedEl) selectElement(t);
                    }},
                    modifiers: [ interact.modifiers.restrictRect({ restriction: 'parent', endOnly: false }) ]
                })
                .resizable({
                    edges: { left: false, right: true, bottom: true, top: false },
                    listeners: { move(e) {
                        const t = e.target;
                        if(t.dataset.type === 'text') return;
                        t.style.width = e.rect.width + 'px';
                        t.style.height = e.rect.height + 'px';
                    }}
                });
        }

        // --- PROPERTIES ---
        function selectElement(el) {
            if(selectedEl) selectedEl.classList.remove('selected');
            selectedEl = el;
            selectedEl.classList.add('selected');
            
            // Show Mobile Sheet
            if(window.innerWidth < 768) document.getElementById('prop-panel').classList.add('open');

            document.getElementById('empty-state').style.display = 'none';
            document.getElementById('controls').style.display = 'block';
            
            const type = selectedEl.dataset.type;
            ['text', 'visual', 'code'].forEach(id => document.getElementById(id+'-inputs').style.display = 'none');

            if(type === 'text') {
                document.getElementById('text-inputs').style.display = 'block';
                document.getElementById('prop-text').value = el.innerText;
                document.getElementById('prop-size').value = parseInt(el.style.fontSize);
                document.getElementById('prop-color').value = rgbToHex(el.style.color);
            }
            else if(type === 'image' || type === 'shape') {
                document.getElementById('visual-inputs').style.display = 'block';
                document.getElementById('btn-replace').style.display = type === 'image' ? 'block' : 'none';
                
                const bg = el.style.backgroundColor;
                if(bg) document.getElementById('prop-fill').value = rgbToHex(bg);
                
                // Border parsing
                const img = el.querySelector('img') || el;
                const border = img.style.border;
                if(border) {
                    const parts = border.split(' ');
                    document.getElementById('prop-border-w').value = parseInt(parts[0]) || 0;
                    if(parts[2]) document.getElementById('prop-border-c').value = rgbToHex(parts[2]);
                } else {
                    document.getElementById('prop-border-w').value = 0;
                }
            }
            else if(type === 'code') {
                document.getElementById('code-inputs').style.display = 'block';
                document.getElementById('prop-code').value = el.dataset.value;
            }
        }

        function deselectAll(e) {
            if(e && e.target.closest('.element')) return;
            if(selectedEl) selectedEl.classList.remove('selected');
            selectedEl = null;
            document.getElementById('prop-panel').classList.remove('open');
            document.getElementById('empty-state').style.display = 'flex';
            document.getElementById('controls').style.display = 'none';
        }

        function closeProps() {
            document.getElementById('prop-panel').classList.remove('open');
        }

        // --- UPDATES ---
        function updateElement(prop) {
            if(!selectedEl) return;
            
            if(prop === 'text') selectedEl.innerText = document.getElementById('prop-text').value;
            if(prop === 'size') selectedEl.style.fontSize = document.getElementById('prop-size').value + 'px';
            if(prop === 'color') selectedEl.style.color = document.getElementById('prop-color').value;
            if(prop === 'align') {
                const v = arguments[1];
                selectedEl.style.textAlign = v;
                selectedEl.style.justifyContent = v === 'center' ? 'center' : (v === 'right' ? 'flex-end' : 'flex-start');
            }
            if(prop === 'bg') selectedEl.style.backgroundColor = document.getElementById('prop-fill').value;
            if(prop === 'radius_slider') {
                const v = document.getElementById('prop-radius').value + '%';
                const t = selectedEl.querySelector('img') || selectedEl;
                t.style.borderRadius = v;
            }
            if(prop === 'border') {
                const w = document.getElementById('prop-border-w').value;
                const c = document.getElementById('prop-border-c').value;
                const t = selectedEl.querySelector('img') || selectedEl;
                t.style.border = w > 0 ? `${w}px solid ${c}` : 'none';
            }
            if(prop === 'code') {
                selectedEl.dataset.value = document.getElementById('prop-code').value;
                renderCode(selectedEl);
            }
        }

        function setCodeType(t) {
            if(selectedEl && selectedEl.dataset.type === 'code') {
                selectedEl.dataset.codeType = t;
                renderCode(selectedEl);
            }
        }

        function toggleStyle(s) {
            if(!selectedEl) return;
            if(s === 'bold') selectedEl.style.fontWeight = selectedEl.style.fontWeight === '700' ? '400' : '700';
        }

        function changeLayer(dir) {
            if(!selectedEl) return;
            let z = parseInt(selectedEl.style.zIndex) || 100;
            if(dir === 'up') z++; else z--;
            selectedEl.style.zIndex = z;
        }

        function deleteSelected() {
            if(selectedEl) { selectedEl.remove(); deselectAll(); }
        }

        // --- ADDERS ---
        function addNewText() {
            createElement({ type: 'text', text: 'New Text', x: 50, y: 50, size: 24, color: '#000' });
        }
        function addNewBarcode() {
            createElement({ type: 'barcode', value: '123456', x: 50, y: 150, w: '200px', h: '60px' });
        }
        function addShape(t) {
            const d = { type: 'shape', x: 50, y: 50, w: '100px', h: '100px', bg: '#3b82f6' };
            if(t === 'circle') d.rounded = '50%';
            createElement(d);
        }
        function addNewImage(e) {
            if(e.target.files[0]) {
                const reader = new FileReader();
                reader.onload = (evt) => createElement({ type: 'image', src: evt.target.result, w: '150px', h: '150px', x: 50, y: 50 });
                reader.readAsDataURL(e.target.files[0]);
            }
            e.target.value = '';
        }
        function triggerReplace() { imgInput.click(); }

        // --- QUEUE ---
        function addToQueue() {
            const html = card.innerHTML;
            const portrait = card.classList.contains('portrait');
            queue.push({ html, portrait });
            renderQueue();
        }
        function renderQueue() {
            const list = document.getElementById('queue-list');
            list.innerHTML = '';
            queue.forEach((_, i) => {
                const d = document.createElement('div');
                d.className = 'flex justify-between p-2 bg-white border rounded text-xs';
                d.innerHTML = `<span>Card ${i+1}</span><button class="text-red-500 font-bold" onclick="removeQ(${i})">X</button>`;
                list.appendChild(d);
            });
            document.getElementById('queue-count').innerText = queue.length;
            renderPrint();
        }
        function removeQ(i) { queue.splice(i, 1); renderQueue(); }
        function clearQueue() { queue = []; renderQueue(); }
        
        function renderPrint() {
            const area = document.getElementById('print-area');
            area.innerHTML = '';
            queue.forEach(item => {
                const w = document.createElement('div');
                w.className = `print-card-wrapper ${item.portrait?'portrait':''}`;
                w.innerHTML = `<div class="print-card-content">${item.html}</div>`;
                area.appendChild(w);
            });
        }

        function rgbToHex(rgb) {
            if(!rgb || rgb.includes('rgba')) return '#000000';
            if(rgb.startsWith('#')) return rgb;
            const v = rgb.match(/\d+/g);
            if(!v) return '#000000';
            return "#" + ((1 << 24) + (parseInt(v[0]) << 16) + (parseInt(v[1]) << 8) + parseInt(v[2])).toString(16).slice(1);
        }
    </script>
</body>
</html>
